---
order: 3
title: Yunzai certification
type: Documents
---

`@yelon/bis` uses the built-in `YzStartupService`, uses the method of interacting with `CAS`, and only provides the `front-end docking` mode (*management authorization/configuration change required*).


## Default initialization


```ts
import {StartupService} from'@core';

export function StartupServiceFactory(startupService: StartupService): () => Observable<void> {
  return () => startupService.load();
}

const APPINIT_PROVIDES = [
  StartupService,
  {
    provide: APP_INITIALIZER,
    useFactory: StartupServiceFactory,
    deps: [StartupService],
    multi: true
  }
];
```

-1. After creating the project through scaffolding, there are the following lines in `app.modules.ts`
-2. You can understand `APPINIT_PROVIDES` as the flag of the project `initialization life cycle`.
-3. When this logo is used, the passed `Factory` will be called.
-4. `StartupServiceFactory` depends on the service of `StartupService`, so use `deps:[StartupService]` to introduce the dependency.
-5.`StartupServiceFactory` calls the `load` function in `Service` to enter the project initialization process.


```ts
@NgModule({
  providers: [...LANG_PROVIDES, ...INTERCEPTOR_PROVIDES, ...I18NSERVICE_PROVIDES, ...APPINIT_PROVIDES],
})
export class AppModule {}
```

Finally imported into `AppModule`: `APPINIT_PROVIDES` in the array


---

`StartupService` provides a set of default application loading mechanism

```ts
@Injectable()
export class StartupService {
  constructor(
    iconSrv: NzIconService,
    private menuService: MenuService,
    @Inject(YUNZAI_I18N_TOKEN) private i18n: I18NService,
    private settingService: SettingsService,
    private aclService: ACLService,
    private titleService: TitleService,
    private httpClient: HttpClient
  ) {
    iconSrv.addIcon(...ICONS_AUTO, ...ICONS);
  }

  load(): Observable<void> {
    const defaultLang = this.i18n.defaultLang;
    return zip(this.i18n.loadLangData(defaultLang), this.httpClient.get('assets/tmp/app-data.json')).pipe(
      // Receive exception messages generated by other interceptors
      catchError(res => {
        console.warn(`StartupService.load: Network request failed`, res);
        return [];
      }),
      map(([langData, appData]: [Record<string, string>, NzSafeAny]) => {
        // setting language data
        this.i18n.use(defaultLang, langData);

        // Application information: including site name, description, year
        this.settingService.setApp(appData.app);
        // User information: including name, profile picture, email address
        this.settingService.setUser(appData.user);
        // ACL: set permissions to full
        this.aclService.setFull(true);
        // Initialize the menu
        this.menuService.add(appData.menu);
        // Set the suffix of the page title
        this.titleService.default ='';
        this.titleService.suffix = appData.app.name;
      })
    );
  }
}
```

---

## yunzai is initializing


The initialization of the yunzai is located in `@yelon/bis`, and provides a set of initialization procedures customized for the authentication of the docking yunzai

```ts
@NgModule({
  providers: [...LANG_PROVIDES, ...INTERCEPTOR_PROVIDES, ...I18NSERVICE_PROVIDES, ...YZ_APPINIT_PROVIDES],
})
export class AppModule {}
```
-1. Delete the original initial configuration `APPINIT_PROVIDES`
-2. Directly reference the initial configuration of `YZ_APPINIT_PROVIDES` in `@yelon/bis` (the last parameter in the code array below)

## i18n initialization


```ts
@Injectable()
export class YzStartupService {
    constructor(
        @Inject(YUNZAI_I18N_TOKEN) private i18n: YzI18NService,
    ) {
      const defaultLang = this.i18n.defaultLang;
    }
}
```

Since `YzI18NService` is introduced in `YzStartupService` to initialize `i18n`

```ts
const I18NSERVICE_PROVIDES = [{ provide: YUNZAI_I18N_TOKEN, useClass: YzI18NService, multi: false }];
```

So you need to change the `I18NService` in `useClass` to `YzI18NService`, **`i18n` configuration is located in `app.module.ts`**.


## Code Analysis


### YzStartupService

```ts
import {APP_INITIALIZER, Inject, Injectable} from'@angular/core';
import {Observable, of} from'rxjs';
import {mergeMap} from'rxjs/operators';

import {NzSafeAny} from'ng-zorro-antd/core/types';
import {NzIconService} from'ng-zorro-antd/icon';

import {ACLService} from'@yelon/acl';
import {BUSINESS_DEFAULT_CONFIG, mergeConfig, ICONS} from'@yelon/bis/shared';
import {CacheService} from'@yelon/cache';
import {Menu, MenuService, SettingsService, TitleService, User, YUNZAI_I18N_TOKEN} from'@yelon/theme';
import {deepCopy, log, YunzaiBusinessConfig, YunzaiConfigService} from'@yelon/util';

import {YzAuthService} from'./yz.auth.service';
import {YzI18NService} from'./yz.i18n.service';

// Recursively convert the menu data in the database into the data type supported by Ng-Yunzai
export function mapYzSideToYelonMenu(menus: Menu[]) {
  menus.forEach(menu => {
    menu.badgeDot = menu.badge_dot || null;
    menu.badgeStatus = menu.badge_status || null;
    menu.shortcutRoot = menu.shortcut_root || null;
    menu.reuse = true;
    if (menu.children) {
      mapYzSideToYelonMenu(menu.children);
    }
  });
}

// Recursively generate authority points from the database menu configuration
export function generateAbility(menus: Menu[], abilities: string[], prefix: string): void {
  menus.forEach(menu => {
    if (menu.link) {
      prefix += menu.link;
    } else {
      prefix +='';
    }
    if (menu.menuAuths) {
      menu.menuAuths.forEach((a: string) => {
        abilities.push(`${prefix}:${a}`);
        abilities.push(a);
      });
    }

    if (menu.children) {
      generateAbility(menu.children, abilities, prefix);
    }
  });
}

@Injectable()
export class YzStartupService {
  // Declare a default configuration
  private bis: YunzaiBusinessConfig = BUSINESS_DEFAULT_CONFIG;

  constructor(
    // ICON configuration
    iconSrv: NzIconService,
    // Menu service
    private menuService: MenuService,
    // i18n service
    @Inject(YUNZAI_I18N_TOKEN) private i18n: YzI18NService,
    // Global Service
    private settingService: SettingsService,
    // Permission service
    private aclService: ACLService,
    // Title service
    private titleService: TitleService,
    // yunzai authentication service
    private yzAuthService: YzAuthService,
    // Cache service
    private cacheService: CacheService,
    // Configure service
    private configService: YunzaiConfigService
  ) {
    // Use the external, that is, the config and default config passed in by the global module to merge
    this.bis = mergeConfig(this.configService);
    // add icon
    iconSrv.addIcon(...ICONS);
  }

  // Initially called by Angular
  load(): Observable<void> {
    log('startup.service:','load');
    // Default configuration of i18n
    const defaultLang = this.i18n.defaultLang;
    return this.i18n.loadLangData(defaultLang).pipe(
      mergeMap(langData => {
        log('startup.service:','set i18n, defaultLang->', defaultLang, 'langData->', langData);
        this.i18n.use(defaultLang, langData);
        return of(null);
      }),
      mergeMap(() => {
          // Call the yunzai authentication service
        return this.yzAuthService.login();
      }),
      mergeMap(v => {
        // preloader finish
        // System initialization after authentication
        this.systemInit();
        log('startup.service: preloader finish');
        // Remove the mask layer and enter the system
        const win = window as NzSafeAny;
        if (win && win.appBootstrap) {
          win.appBootstrap();
        }
        return of(v);
      })
    );
  }

  systemInit(): void {
    log('startup.service: system init');
    // Get user from cache
    const user: User = this.cacheService.get('_yz_user', {mode:'none' });
    // Filter out the menu of the current system from the cache
    const ms = deepCopy(user.menu).filter((m: Menu) => m.systemCode && m.systemCode === this.bis.systemCode) as Menu[];
    // Menu switch
    mapYzSideToYelonMenu(ms);
    const currentMenu = ms.pop()!;
    // Menu service settings upper menu
    this.menuService.add([currentMenu]);

    // set LOGO
    this.settingService.setApp({ name: currentMenu.text, description: currentMenu.intro });
    this.settingService.setUser({
      name: user.realname ||'no name',
      avatar: `${this.bis.baseUrl}/filecenter/file/${user.avatarId}` ||'',
      email: user.email ||'no email'
    });

    // set title
    this.titleService.default = currentMenu.text ||'default application name';
    this.titleService.setTitle(currentMenu.text ||'no title');

    // Set authority points
    const abilities: string[] = [];
    generateAbility([currentMenu], abilities,'');
    this.aclService.add({
      role:
        user?.roles
          .map((role: NzSafeAny) => {
            return role.roleValue;
          })
          .filter((a: NzSafeAny) => !!a) || [],
      ability: abilities
    });

    // Set the current system information to the cache
    this.cacheService.set('_yz_current', {
      text: currentMenu.text,
      intro: currentMenu.intro,
      icon: currentMenu.appIconUrl
    });
  }
}

export function YzStartupServiceFactory(startupService: YzStartupService): () => Observable<void> {
  return () => startupService.load();
}

//@ts-ignore
export const YZ_APPINIT_PROVIDES = [
  YzStartupService,
  {
    provide: APP_INITIALIZER,
    useFactory: YzStartupServiceFactory,
    deps: [YzStartupService],
    multi: true
  }
];

```

### YzAuthService

```ts
import {Injectable, Injector} from'@angular/core';
import {forkJoin, Observable, of} from'rxjs';
import {map, mergeAll, mergeMap} from'rxjs/operators';

import {NzSafeAny} from'ng-zorro-antd/core/types';

import {ITokenModel, ITokenService, mergeConfig as mergeAuthConfig, YA_SERVICE_TOKEN} from'@yelon/auth';
import {mergeConfig as mergeBisConfig} from'@yelon/bis/shared';
import {CacheService} from'@yelon/cache';
import {_HttpClient} from'@yelon/theme';
import {WINDOW, YunzaiAuthConfig, YunzaiBusinessConfig} from'@yelon/util';
import {YunzaiConfigService} from'@yelon/util/config';
import {log} from'@yelon/util/other';

@Injectable({ providedIn:'root' })
export class YzAuthService {
  // Two configurations
  protected option: YunzaiAuthConfig;
  protected bis: YunzaiBusinessConfig;

  constructor(private injector: Injector) {
    // Merge the default configuration and the configuration passed in by global
    this.option = mergeAuthConfig(this.csr);
    this.bis = mergeBisConfig(this.csr);
  }

  // Inject YunzaiConfig service
  private get csr(): YunzaiConfigService {
    return this.injector.get(YunzaiConfigService);
  }

  // Inject Token service
  private get tokenService(): ITokenService {
    return this.injector.get(YA_SERVICE_TOKEN);
  }

  // Inject Http service
  private get httpClient(): _HttpClient {
    return this.injector.get(_HttpClient);
  }

  // Inject the cache service
  private get cacheService(): CacheService {
    return this.injector.get(CacheService);
  }

  // try to withdraw the token
  askToken(): Observable<ITokenModel> {
    log('yz.auth.service:','askToken');
    // If TokenService contains Token then return directly
    if (this.tokenService.get()?.token) {
      return of(this.tokenService.get()!);
    } else {
      // The local development mode is judged by whether there is a login form
      if (this.bis.loginForm) {
        // Log in locally
        return this.fetchTokenByUP();
      } else {
        // Obtain Token through CAS normally
        return this.fetchTokenByCas();
      }
    }
  }

  fetchTokenByUP(): Observable<ITokenModel> {
    log('yz.auth.service:','fetchTokenByUP');
    // Send request in exchange for Token
    return this.httpClient.post(`/auth/oauth/token?_allow_anonymous=true`, this.bis.loginForm).pipe(
      map((response: NzSafeAny) => {
        const {access_token, expires_in, refresh_token, scope, token_type} = response;
        return {
          token: access_token,
          expired: expires_in,
          refreshToken: refresh_token,
          tokenType: token_type,
          scope
        };
      })
    );
  }

  fetchTokenByCas(): Observable<ITokenModel> {
    log('yz.auth.service:','fetchTokenByCas');
    // Jump back address
    const uri = encodeURIComponent(this.injector.get(WINDOW).location.href);
    // Send a get request to the cas service and pass in the callback address
    return this.httpClient
      .get(`/cas-proxy/app/validate_full?callback=${uri}&_allow_anonymous=true&timestamp=${new Date().getTime()}`)
      .pipe(
        map((response: NzSafeAny) => {
          switch (response.errcode) {
            // 2000, I have logged in, get the Token directly
            case 2000:
              const {access_token, expires_in, refresh_token, scope, token_type} = response.data;
              return {
                token: access_token,
                expired: expires_in,
                refreshToken: refresh_token,
                tokenType: token_type,
                scope
              } as ITokenModel;
            // 2001, I have not logged in before, and I returned the login address via response, go to log in
            case 2001:
              this.injector.get(WINDOW).location.href = response.msg;
              throw Error("Cookie Error: Can't find Cas Cookie,So jump to login!");
            default:
              if (response.data) {
                console.error(response.data);
                throw Error(response.data);
              } else if (response.msg) {
                console.error(response.msg);
                throw Error(response.msg);
              } else {
                console.error('cas unknown error');
                throw Error('Unknown Error: Cas auth exception!');
              }
          }
        })
      );
  }

  login(): Observable<void> {
    log('yz.auth.service:','login white login form->', this.bis.loginForm);
    // The first step is to try to get Token
    return this.askToken().pipe(
      mergeMap(token => {
        log('yz.auth.service: get token->', token);
        this.csr.set('auth', {
          token_send_key:'Authorization',
          token_send_template: `${token.tokenType} \${token}`,
          token_send_place:'header'
        });
        log('yz.auth.service:','set token');
        this.tokenService.set(token);
        // The second step is to cache all the information needed by the system
        return this.cacheInit();
      }),
      mergeAll()
    );
  }

  cacheInit(): Observable<void[]> {
    log('yz.auth.service:','cacheInit');
    // try to get the cache
    const user = this.cacheService.get('_yz_user', {mode:'none' });
    const header = this.cacheService.get('_yz_header', {mode:'none' });
    const project = this.cacheService.get('_yz_project_info', {mode:'none' });
    return forkJoin(of(user), of(header), of(project)).pipe(
      mergeMap(([u, h, p]) => {
        let list = [];
        // If you can't get it
        if (!u) {
          log('yz.auth.service:','fetch user cache');
          list.push(
              // Re-request
            this.httpClient.get(`/auth/user`).pipe(
              map((user: NzSafeAny) => {
                  // set cache
                this.cacheService.set('_yz_user', user.principal);
              })
            )
          );
        } else {
          log('yz.auth.service:','user recache');
          list.push(of<NzSafeAny>(() => {}));
        }
        // header cache
        if (!h) {
          log('yz.auth.service:','fetch header cache');
          list.push(
            this.httpClient.get(`/auth/allheader/v2`).pipe(
              map((header: NzSafeAny) => {
                this.cacheService.set('_yz_header', header.data);
              })
            )
          );
        } else {
          log('yz.auth.service:','header recache');
          list.push(of<NzSafeAny>(() => {}));
        }
        // project cache
        if (!p) {
          log('yz.auth.service:','fetch project cache');
          list.push(
            this.httpClient.get(`/app-manager/project/info`).pipe(
              map((info: NzSafeAny) => {
                this.cacheService.set('_yz_project_info', info.data);
              })
            )
          );
        } else {
          log('yz.auth.service:','project recache');
          list.push(of<NzSafeAny>(() => {}));
        }
        return forkJoin(list);
      })
    );
  }
}

```
